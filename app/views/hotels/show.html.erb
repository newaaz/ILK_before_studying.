<% provide(:title, @hotel.name) %>
<% content_for(:javascript_plugin_header) do %>
  <%= javascript_pack_tag 'main/fotorama', 'data-turbolinks-track': 'reload'%>
<% end %>


<div class="breadcrumbs">
  <div class="container">
    <i class="icon-location-outline" style="font-size:15px"></i>
    <%= link_to @hotel.town.name, @hotel.town %>&nbsp;/
    <%= link_to "Жильё", hotels_town_path(@hotel.town) %>&nbsp;/
    <%= link_to @hotel.hotel_category.name, hotels_town_path(@hotel.town, { cat: @hotel.hotel_category.id }) %>&nbsp;/
    <%= @hotel.name %>
  </div>
</div>

<main class="hotels-show">

<div class="container"> 

   <!-- title -->
  <div class="row mt-3">
    <div class="col-md-1 ps-1">
      <% if @current_item %>
        <%= button_to line_items_path(resource_id: @hotel.id, resource_name: "Hotel"), remote: true, id: "heart-Hotel-#{@hotel.id}",
                                                              class: "d-inline btn btn-link text-danger" do %>
          <i class="fas fa-heart fa-lg"></i>
        <% end %>
      <% else %>
        <%= button_to line_items_path(resource_id: @hotel.id, resource_name: "Hotel"), remote: true, id: "heart-Hotel-#{@hotel.id}",
                                                              class: "d-inline btn btn-link" do %>
          <i class="fas fa-heart fa-lg"></i>
        <% end %>
      <% end %>   
    </div>
    <div class="col-md-11 px-0">
      <h1 class="d-inline"><%= @hotel.name %></h1>&emsp;
      <i class="icon_set_1_icon-37"></i> <%= @hotel.desc_json["town_name"] %>, <%= @hotel.address %>
    </div>    
  </div>

  <!-- photo + contacts & map -->
  <div class="row">
    
    <div class="col-lg-9">
   

      <!-- fotorama begin -->        
      <div class="fotoramain">
        <%= link_to image_tag(@hotel.avatar.thumb.url), @hotel.avatar.url %>
        <% @hotel.images.each do |image| %>
          <%= link_to image_tag(image.thumb.url), image.url %>
        <% end %>
      </div>        
      <!-- fotorama end -->
    </div>

    <div class="col-lg-3">   

      <%= render 'contacts' %>      

    </div>

  </div>  

  <!-- desc & rooms / + NEAR -->
  <div class="row">
    
    <div class="col-lg-9">
      
      <!-- DESCRIPTION -->
      <div class="tabset" style="font-size:15px;">

        <!-- Tab description-->
        <input type="radio" name="tabset" id="tab1" aria-controls="desc" checked>
        <label for="tab1">Описание</label>

         <!-- Tab description-->
        <input type="radio" name="tabset" id="tab7" aria-controls="infrastructure">
        <label for="tab7">Инфраструктура</label> 

        <!-- Tab places near-->
        <input type="radio" name="tabset" id="tab4" aria-controls="place-near">
        <label for="tab4">На карте</label>

        <!-- Tab rules-->
        <input type="radio" name="tabset" id="tab5" aria-controls="rules">
        <label for="tab5">Правила и скидки</label>

         <!-- Tab prices-->
         <input type="radio" name="tabset" id="tab6" aria-controls="prices">
         <label for="tab6">Календарь цен</label>
        
        <div class="tab-panels">

          <!-- Tab DESC -->
          <section id="desc" class="tab-panel">
            <strong>Море</strong> ~ <%= @hotel.distance_to_sea %>м. || <strong>Цена от</strong> - <%= @hotel.price_from %><small>руб.</small> || <strong>Работает круглогодично</strong> ||
            <strong>Этажей</strong> : <%= @hotel.desc_json["floors"] %> || <strong>Кол-во зданий</strong> : <span class="strong">1</span>
            <br>
            <%  if @hotel.description.to_plain_text.size > 626 %>            
              <a class="content_toggle btn btn-warning btn-sm" href="#"><i class='icon-angle-down'></i> Показать далее</a>
              <div class="content_block hide">
              <%= @hotel.description %>
              <a class="content_toggle" href="#"></a>
              </div>          
            <% else %>
              <%= @hotel.description %>
            <% end %>
          </section>

          <section id="infrastructure" class="tab-panel" style="line-height:24px">            
            <table class="table table-striped">
              <tr>
                <th scope="row" class="px-1"><i class="icon_set_1_icon-58" style="font-size:20px"></i></th>
                <th scope="row" class="px-0">Питание:</th>
                <td><%= @hotel.desc_json["food"] %></td>       
              </tr>
              <tr>
                <th scope="row" class="px-1"><i class="icon_set_1_icon-58" style="font-size:20px"></i></th>
                <th scope="row" class="px-0">Парковка:</th>
                <td><%= @hotel.desc_json["parking"] %></td>            
              </tr>
              <tr>
                <th scope="row" class="px-1"><i class="icon_set_1_icon-58" style="font-size:20px"></i></th>
                <th scope="row" class="px-0">Территория:</th>
                <td><%= @hotel.desc_json["territory"] %></td>            
              </tr>
              <tr>
                <th scope="row" class="px-1"><i class="icon_set_1_icon-58" style="font-size:20px"></i></th>
                <th scope="row" class="px-0">Сервис и услуги:</th>
                <td><%= @hotel.desc_json["service"] %></td>            
              </tr>
              <tr>
                <th scope="row" class="px-1"><i class="icon_set_1_icon-58" style="font-size:20px"></i></th>
                <th scope="row" class="px-0">Трансфер:</th>
                <td><%= @hotel.desc_json["transfer"] %></td>            
              </tr>
              <tr>
                <th scope="row" class="px-1"><i class="icon_set_1_icon-58" style="font-size:20px"></i></th>
                <th scope="row" class="px-0">Дополнительно:</th>
                <td><%= @hotel.desc_json["addition"] %></td>            
              </tr>          
            </table>
          </section>    
  
          <!-- Tab MAP -->
          <section id="place-near" class="tab-panel">

            <h5 class="mb-3"><i class="icon_set_1_icon-37"></i> <%= @hotel.desc_json["town_name"] %>, <%= @hotel.address %></h5>
            <div id="map" style="height: 300px" class="border shadow"></div>
            
          </section>

          <!-- Tab RULES -->
          <section id="rules" class="tab-panel" style="line-height:24px">
             <table class="table table-striped">
              <tr>
                <th scope="row" class="px-1"><i class="icon_set_1_icon-58" style="font-size:20px"></i></th>
                <th scope="row" class="px-0">Рассчётное время:</th>
                <td><%= @hotel.desc_json["check_time"] %></td>       
              </tr>
              <tr>
                <th scope="row" class="px-1"><i class="icon_set_1_icon-58" style="font-size:20px"></i></th>
                <th scope="row" class="px-0">Минимальный срок проживания:</th>
                <td><%= @hotel.desc_json["min_check"] %></td>            
              </tr>
              <tr>
                <th scope="row" class="px-1"><i class="icon_set_1_icon-58" style="font-size:20px"></i></th>
                <th scope="row" class="px-0">Оплата:</th>
                <td><%= @hotel.desc_json["payment"] %></td>            
              </tr>
              <tr>
                <th scope="row" class="px-1"><i class="icon_set_1_icon-58" style="font-size:20px"></i></th>
                <th scope="row" class="px-0">Скидки и акции:</th>
                <td><%= @hotel.desc_json["bonus"] %></td>            
              </tr>
              <tr>
                <th scope="row" class="px-1"><i class="icon_set_1_icon-58" style="font-size:20px"></i></th>
                <th scope="row" class="px-0">Размещение детей:</th>
                <td><%= @hotel.desc_json["child"] %></td>            
              </tr>
              <tr>
                <th scope="row" class="px-1"><i class="icon_set_1_icon-58" style="font-size:20px"></i></th>
                <th scope="row" class="px-0">Размещение животных:</th>
                <td><%= @hotel.desc_json["animals"] %></td>            
              </tr>          
            </table>
          </section>

          <!-- Tab PRICES -->
          <section id="prices" class="tab-panel">
            <% if current_user && (current_user?(@hotel.user) || current_user.admin?) %>
              <%= link_to "Edit", edit_hotel_path(@hotel) ,class: "btn btn-outline-success btn-sm" %>
              <%= link_to "+ Room", new_room_path(hotel_id: @hotel.id), class: "btn btn-outline-success btn-sm" %>
              <%= link_to "Delete", @hotel, method: :delete, data: { confirm: "Вы уверены?" }, class: "btn btn-outline-danger btn-sm" %>
            <% end %>        
            <table class="room__table">
                <thead>
                  <tr>
                    <th>Номер</th>
                    <th>29.04-07.06</th>
                    <th>08.06-28.06</th>
                    <th>29.06-19.07</th>
                    <th>20.07-26.08</th>
                    <th>27.08-06.09</th>
                    <th>07.09-30.09</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>2 этаж</td>
                    <td style="text-align: center; color: #333">3000р</td>
                    <td style="text-align: center; color: #333">3000р</td>
                    <td style="text-align: center; color: #333">4000р</td>
                    <td style="text-align: center; color: #333">4500р</td>
                    <td style="text-align: center; color: #333">4000р</td>
                    <td style="text-align: center; color: #333">2800р</td>
                  </tr>
                  <tr>
                    <td>3 этаж</td>
                    <td style="text-align: center">2500р.</td>
                    <td style="text-align: center">3000р.</td>
                    <td style="text-align: center">4000р.</td>
                    <td style="text-align: center">4500р.</td>
                    <td style="text-align: center">4000р.</td>
                    <td style="text-align: center">2800р.</td>
                  </tr>                       
                </tbody>
              </table>
          </section>

        </div>

      </div>

      <!-- PRICES FLAT -->
      <% if @hotel.desc_json["prices"].any? %>
        <h3>Календарь цен</h3>
        <div style="overflow-x:auto;">
          <div class="room-prices">
            <% @hotel.desc_json["prices"].each do |price| %>
              <div class="period">
                <div class="period__date"><%= Date.parse(price["start_date"]).strftime('%d/%m') %>-<%= Date.parse(price["end_date"]).strftime('%d/%m') %></div>
                <div class="period__price"><%= price["day_cost"] %><span>руб.</span></div>
              </div>
            <% end %>    
          </div>
        </div>
      <% end %>      
      <!-- END PRICES FLAT -->  

      <!-- ROOMS -->      
      <% if @hotel.rooms.any? %>
        <h3 class="mb-4">Номера:</h3>
        <%= render @hotel.rooms %>
      <% end %>
      

    </div>

    <div class="col-lg-3 pe-0">
      <!-- NEAR -->      
      <div class="resource_near"><!-- Hotels NEAR -->
        <h4>Жильё рядом</h4>
        <% hotels_near(@hotel).each do |hotel_near| %>          
          <div class="d-flex align-items-center border rounded bg-white shadow mb-2"> 
            <div class="flex-shrink-0">
              <%= link_to image_tag(hotel_near.avatar.thumb.url, style: "width: 100px", class: 'rounded-start'), hotel_near %>
            </div>           
            <div class="flex-grow-1 ps-2">
              <h6><%= link_to hotel_near.name, hotel_near %></h6>
              <span style="font-size: 18px; color: orangered;">
                <i class="fas fa-map-marked-alt"></i>
              </span>
              <small>~<%= distance_between(@hotel, hotel_near) %>м.</small>
            </div>            
          </div>
        <% end %>
      </div>
      <div class="resource"><!-- Cafebars NEAR -->
        <h4>Кафе, бары, рестораны рядом</h4>
        <% cafebars_near(@hotel).each do |cafebar_near| %>          
          <div class="d-flex align-items-center border rounded bg-white shadow mb-2">            
            <div class="flex-grow-1 ps-2">
              <h6><%= link_to cafebar_near.name, cafebar_near %></h6>
              <span style="font-size: 18px; color: orangered;">
                <i class="fas fa-map-marked-alt"></i>
              </span>
              <small>~<%= distance_between(@hotel, cafebar_near) %>м.</small>
            </div>
            <div class="flex-shrink-0">
              <%= link_to image_tag(cafebar_near.avatar.thumb.url, style: "width: 100px", class: 'rounded-end'), cafebar_near %>
            </div>
          </div>
        <% end %>
      </div>
      <!-- end NEAR -->
    </div>    

  </div>

</div>

</main>



<script type="text/javascript"> // map
  ymaps.ready(init);
  function init(){
    const coords = [<%= @hotel.latitude %>, <%= @hotel.longitude %>]      
    var myMap = new ymaps.Map("map", {
        center: coords,
        zoom: 14,
        behaviors: ['drag','dblClickZoom', 'multiTouch']
    });    
    var myPlacemark = new ymaps.Placemark(coords, {
      balloonContentHeader: 'Однажды',
      balloonContentBody: 'В студеную зимнюю пору',
      balloonContentFooter: 'Мы пошли в гору',
      hintContent: 'Зимние происшествия'
    }, {
      preset: "islands#blueHomeIcon"
    });
    myMap.geoObjects.add(myPlacemark);
  };  
</script>

<script>  // More... hidden
  var btnsMore = document.getElementsByClassName('more-info');
  for (var i = 0; i < btnsMore.length; i++) {
    btnsMore[i].addEventListener("click", function() {
      let indexRoom = 'room-hidden-'+ this.dataset.room;
      let hiddenContent = document.getElementById(indexRoom);      
      if (hiddenContent.style.display === "none") {
        hiddenContent.style.display = "block";
        this.innerHTML = "<i class='icon-angle-up'></i> Скрыть";
      } else {
        hiddenContent.style.display = "none";
        this.innerHTML = "<i class='icon-angle-down'></i> Подробнее";
      }
    })
  }; 
</script>

<script>//Initialize fotorama manually for rooms.
  $(document).on('turbolinks:load', function() {
    $(function () {

      // Initialize main fotorama
      $('.fotoramain').fotorama({
        width: 990,
        ratio: 3/2,
        allowfullscreen: true,
        nav: 'thumbs',
        loop: true,
        keyboard: true,
      })

      //Initialize fotorama manually for rooms
      var $fotoramaDiv = $('.fotorama-rooms').fotorama();

      $fotoramaDiv.on('fotorama:fullscreenenter',
        function (e, fotorama) {        
          fotorama.setOptions({
            nav: "thumbs"
          });
        });
      
      $fotoramaDiv.on('fotorama:fullscreenexit',
      function (e, fotorama) {      
        fotorama.setOptions({
          nav: "false"
        });
      })
    });
  }); 
</script>

<script>// description more
  $(document).ready(function(){
    $('.content_toggle').click(function(){
      $('.content_block').toggleClass('hide');	
      if ($('.content_block').hasClass('hide')) {
        $('.content_toggle').html('<i class="icon-angle-down"></i> Показать далее');
      } else {
        $('.content_toggle').html('<i class="icon-angle-up"></i> Свернуть');
      }		
      return false;
    });				
  });
</script>





